<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>资源类配置</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="lib/layui/css/layui.css">
    <link rel="stylesheet" href="css/scroll-bar.css">
    <link rel="stylesheet" href="css/sub-page.css">
    <!--<link rel="stylesheet" href="//at.alicdn.com/t/font_693759_wytlyqhtdtj1nhfr.css">-->
    <link rel="stylesheet" href="lib/nprogress/nprogress.css">
    <link rel="stylesheet" href="css/page.css?2">
    <link rel="stylesheet" href="css/font-awesome.min.css">
</head>
<body>
<div class="layui-element" id="vue-element">
    <!--导航区域-->
    <div class="layui-tab">
        <ul class="layui-tab-title">
            <li class="layui-this">基础设施层</li>
            <li>虚拟资源层</li>
            <li>平台资源层</li>
            <li>业务应用层</li>
            <li>管理资源层</li>
        </ul>
        <!--导航内容-->
        <div class="layui-tab-content">
            <!--基础设施层start-->
            <div class="layui-tab-item layui-show">
                <div class="head-title-box">
                    <button class="layui-btn ">添加属性</button>
                    <button class="layui-btn layui-btn-primary">添加类关系</button>
                </div>
                <div class="layui-row">
                    <!--左边导航-->
                    <div class="layui-col-xs2 related">
                        <div class="left-nav-box bg-gary">
                            <template>
                                <div class="left-nav-item" v-for="item in left_nav" :key="item.id" :class="item.selected?'active':''" v-on:click="selectNav(item)">
                                    {{ item.name }}
                                    <img src="images/edit.png" v-on:click.stop="navEdit">
                                </div>
                                <div class="left-nav-btn">
                                    <button class="layui-btn layui-btn-sm">添加资源类</button>
                                </div>
                            </template>
                        </div>
                    </div>
                    <!--基本信息-->
                    <div class="layui-col-xs10">
                        <template class="layui-row">
                            <div class="layui-col-xs9">
                                <div class="form-box">
                                    <div class="form-head">
                                        基本信息
                                    </div>
                                    <drop class="form-item-box" @drop="handleDrop">
                                        <form class="layui-form" action="">
                                            <div class="form-item"
                                                 v-for="item of cur_select.attr"
                                            >
                                                <div class="form-item-head">
                                                    {{ item.title }} <span class="red" v-if='item.required'>*</span>：
                                                </div>
                                                <div class="form-item-center">
                                                    <input v-if="item.type=='text'||item.type=='number'" :lay-verify="layVerify(item)" :data-item="JSON.stringify(item)"
                                                           v-model="item.value" :type="item.type" name="title" autocomplete="off" :placeholder="'请输入' + item.title" class="layui-input"/>
                                                    <textarea v-if="item.type=='textarea'" :lay-verify="layVerify(item)" :data-item="JSON.stringify(item)"
                                                              v-model="item.value" autocomplete="off" :placeholder="'请输入' + item.title" class="layui-textarea"></textarea>
                                                    <select v-if="item.type=='pulldown'" v-model="item.value" :lay-verify="layVerify(item)">
                                                        <option value="">请选择</option>
                                                        <option v-for="op of item.options" :value="op.opName">{{op.opName}}</option>
                                                    </select>
                                                    <select v-if="item.type=='useobj'" v-model="item.value" :lay-verify="layVerify(item)">
                                                        <option value="">请选择</option>
                                                        <option v-for="op of item.options" :value="op.opName">{{op.opName}}</option>
                                                    </select>
                                                    <input type="text" class="layui-input" v-if="item.type=='dateTime'" :id="'laydate'+item.title" placeholder="yyyy-MM-dd">
                                                    <div v-if="item.type=='checkbox'">
                                                        <input type="checkbox" v-for="op of item.options" :title="op.opName" :checked="op.isSelect">
                                                    </div>
                                                    <div v-if="item.type=='radio'">
                                                        <input type="radio" :name="item.title" v-for="op of item.options" :title="op.opName" :value="op.opName" :checked="op.isSelect">
                                                    </div>
                                                    <table v-if="item.type=='table'" class="layui-hide" :id="'laytable'+item.title"></table>
                                                    <input v-if="item.type=='file'" :lay-verify="layVerify(item)" class="input-file" type="file" v-on:change="(e)=>{changeFile(e,item)}" />
                                                </div>
                                                <div class="form-item-right" v-if="item.hasRightText||item.unit">
                                                    <div v-if="item.hasRightText">* 名称为固定选项，不可去除；</div>
                                                    <div v-if="item.unit">单位：{{item.unit}}</div>
                                                </div>
                                            </div>
                                            <div class="form-item">
                                                <div class="form-item-head"> </div>
                                                <button class="layui-btn " lay-submit lay-filter="*">提交</button>
                                            </div>
                                        </form>
                                    </drop>
                                </div>
                            </div>
                            <div class="layui-col-xs3">
                                <div class="drap-box">
                                    <drag class="drap-item"
                                          v-for="item of drap_icon"
                                          :key="item.title"
                                          :transfer-data="item"
                                          :effect-allowed="['copy']"
                                          drop-effect="copy"
                                    >
                                    <span>
                                        <img :src="item.src">
                                    </span>
                                        <span style="margin-top: 5px">
                                        {{ item.title }}
                                    </span>
                                    </drag>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            <!--基础设施层end-->
            <div class="layui-tab-item">虚拟资源层</div>
            <div class="layui-tab-item">平台资源层</div>
            <div class="layui-tab-item">业务应用层</div>
            <div class="layui-tab-item">管理资源层</div>
        </div>
    </div>


    <!--拖拽弹窗-->
    <template v-if="msgBoxShow">
        <div class="msg-box" >
            <div class="msg-box-bg"></div>
            <div class="msg-content-box">
                <div class="msg-content-title">
                    添加属性 - {{ cur_drap.title }}
                    <i class="layui-icon layui-icon-close" v-on:click="msgBoxShow=false" style="float: right;cursor: pointer"></i>
                </div>
                <div class="msg-content">
                    <form class="layui-form">
                        <div class="msg-content-item" v-for="item of cur_drap.parm">
                            <div class="msg-content-item-title">
                                <span class="red" v-if="item.required">*</span>{{ item.lable }}：
                                <div v-if="item.type=='options'" class="layui-btn layui-btn-sm" style="float: right" v-on:click="addOption(item)">添加</div>
                            </div>
                            <div class="msg-content-item-input" >
                                <input type="checkbox" v-if="item.name=='required'" v-model="item.value" ref="required" lay-skin="switch" lay-text="是|否">
                                <input type="checkbox" v-if="item.name=='required_data'" v-model="item.value" ref="required_data" lay-skin="switch" lay-text="是|否">
                                <input type="text" v-if="item.type=='dateTime'" class="layui-input" id="laydata" v-model="item.value" ref='dateTime' placeholder="yyyy-MM-dd">
                                <template v-if="item.type=='text'||item.type=='number'">
                                    <input :type="item.type" :placeholder="'请输入' + item.lable" v-model="item.value" autocomplete="off" class="layui-input">
                                    <div v-if="item.name=='code'" class="msg-content-item-tips">请输入3-30个字母或数字，且首个字符必须为字母；</div>
                                </template>
                                <select name="rules" v-if="item.type=='select'&&(item.name=='rules'||item.name=='useobj')" v-model="item.value" ref="rules">
                                    <option value="">请选择</option>
                                    <option value="111">无校验</option>
                                    <option value="010">IP地址</option>
                                    <option value="021">邮箱</option>
                                </select>
                                <template v-if="item.type=='options'&&(item.name=='options'||item.name=='table')">
                                    <div v-for="(op,i) of item.options" :key="i" class="msg-content-item-pulldown">
                                        <i :class="op.isSelect?'fa fa-check-circle':'fa fa-circle-thin'" class="pulldown-hover" v-if="item.name=='options'" aria-hidden="true" v-on:click="checkOption(item,i)"></i>
                                        <input v-model="op.opName" placeholder="请输入选项名称"/>
                                        <i class="fa fa-trash-o" v-on:click="item.options.splice(i,1)"></i>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </form>
                    <button class="layui-btn" @click="saveDrap">保存</button>
                </div>
            </div>
        </div>
    </template>

</div>
<!--js逻辑-->
<script src="lib/layui/layui.js"></script>
<script src="js/vue.min.js"></script>
<script src="lib/nprogress/nprogress.js"></script>
<!--拖拽-->
<script src="js/sortable.js"></script>
<script src="js/vuedraggable.js"></script>
<script src="js/vue-drag-drop.browser.js"></script>
<script>
    NProgress.start();
    window.onload = function () {
        NProgress.done();
    }
</script>
<script src="lib/layui/layui.js"></script>
<!-- vueJs -->
<script>
    new Vue({
        el: '#vue-element',
        data() {
            return{
                /* 基础设施层 */
                // 左边导航
                left_nav:[{
                    id: 0,
                    name: '机房',
                    selected: true,
                    //属性 title.required,hasRightText,value
                    attr: [{
                        title: '名称',//显示title
                        type: 'text',//类型
                        required: true,//是否必填
                        hasRightText: true,//显示（名称为固定选项，不可去除；）
                        value:'',//值
                    }],
                    //类关系
                    class: {

                    }
                },{
                    id: 1,
                    name: '机柜',
                    selected: false,
                    attr: [{
                        title: '名称',//显示title
                        type: 'text',//类型
                        required: true,//是否必填
                        hasRightText: true,//显示（名称为固定选项，不可去除；）
                        value:'',//值
                    }],
                    //类关系
                    class: {

                    }
                },{
                    id: 2,
                    name: 'PC服务器',
                    selected: false,
                    attr: [{
                        title: '名称',//显示title
                        type: 'text',//类型
                        required: true,//是否必填
                        hasRightText: true,//显示（名称为固定选项，不可去除；）
                        value:'',//值
                    }],
                    //类关系
                    class: {

                    }
                },],
                cur_select: {},
                cur_drap: {},
                msgBoxShow: false,
                // 拖拽图标
                drap_icon:[
                    {
                        title: "单行文本",
                        type: 'text',
                        src: 'images/d-text.png',
                        parm: [
                            {
                                name: 'name',
                                lable: '字段名称',
                                value: '',
                                type: 'text',
                                required: true
                            },{
                                name: 'default',
                                lable: '默认值',
                                value: '',
                                type: 'text',
                                required: false
                            },{
                                name: 'required',
                                lable: '是否必填',
                                value: false,
                                type: 'check',
                                required: false
                            },{
                                name: 'rules',
                                lable: '校验规则',
                                value: '',
                                type: 'select',
                                required: false
                            },{
                                name: 'minLength',
                                lable: '最小文本长度',
                                value: '',
                                type: 'number',
                                required: false
                            },{
                                name: 'maxLength',
                                lable: '最大文本长度',
                                value: '',
                                type: 'number',
                                required: false
                            }]
                    },{
                        title: "多行文本",
                        type: 'textarea',
                        src: 'images/d-textarea.png',
                        parm: [
                            {
                                name: 'name',
                                lable: '字段名称',
                                value: '',
                                type: 'text',
                                required: true
                            },{
                                name: 'default',
                                lable: '默认值',
                                value: '',
                                type: 'text',
                                required: false
                            },{
                                name: 'required',
                                lable: '是否必填',
                                value: false,
                                type: 'check',
                                required: false
                            },{
                                name: 'rules',
                                lable: '校验规则',
                                value: '',
                                type: 'select',
                                required: false
                            },{
                                name: 'minLength',
                                lable: '最小文本长度',
                                value: '',
                                type: 'number',
                                required: false
                            },{
                                name: 'maxLength',
                                lable: '最大文本长度',
                                value: '',
                                type: 'number',
                                required: false
                            }]
                    },{
                        title: "数值",
                        type: 'number',
                        src: 'images/d-textarea.png',
                        parm: [
                            {
                                name: 'name',
                                lable: '字段名称',
                                value: '',
                                type: 'text',
                                required: true
                            },{
                                name: 'default',
                                lable: '默认值',
                                value: '',
                                type: 'text',
                                required: false
                            },{
                                name: 'unit',
                                lable: '单位',
                                value: '',
                                type: 'text',
                                required: false
                            },{
                                name: 'required',
                                lable: '是否必填',
                                value: false,
                                type: 'check',
                                required: false
                            },{
                                name: 'minDigit',
                                lable: '最小位数',
                                value: '',
                                type: 'number',
                                required: false
                            },{
                                name: 'minLength',
                                lable: '最小文本长度',
                                value: '',
                                type: 'number',
                                required: false
                            },{
                                name: 'maxLength',
                                lable: '最大文本长度',
                                value: '',
                                type: 'number',
                                required: false
                            }]
                    },{
                        title: "下拉",
                        type: 'pulldown',
                        src: 'images/d-select.png',
                        parm: [
                            {
                                name: 'name',
                                lable: '字段名称',
                                value: '',
                                type: 'text',
                                required: true
                            },{
                                name: 'required',
                                lable: '是否必填',
                                value: false,
                                type: 'check',
                            },{
                                name: 'options',
                                lable: '选项',
                                value: '',
                                type: 'options',
                                options: []
                            }]
                    },{
                        title: "多选",
                        type: 'checkbox',
                        src: 'images/d-checkgroup.png',
                        parm: [
                            {
                                name: 'name',
                                lable: '字段名称',
                                value: '',
                                type: 'text',
                                required: true
                            },{
                                name: 'required',
                                lable: '是否必填',
                                value: false,
                                type: 'check',
                            },{
                                name: 'options',
                                lable: '选项',
                                value: '',
                                type: 'options',
                                options: []
                            }]
                    },{
                        title: "单选",
                        type: 'radio',
                        src: 'images/d-check.png',
                        parm: [
                            {
                                name: 'name',
                                lable: '字段名称',
                                value: '',
                                type: 'text',
                                required: true
                            },{
                                name: 'required',
                                lable: '是否必填',
                                value: false,
                                type: 'check',
                            },{
                                name: 'options',
                                lable: '选项',
                                value: '',
                                type: 'options',
                                options: []
                            }]
                    },{
                        title: "日期和时间",
                        type: 'dateTime',
                        src: 'images/d-date.png',
                        parm: [
                            {
                                name: 'name',
                                lable: '字段名称',
                                value: '',
                                type: 'text',
                                required: true
                            },{
                                name: 'required',
                                lable: '是否必填',
                                value: false,
                                type: 'check',
                            },{
                                name: 'required_data',
                                lable: '仅日期',
                                value: false,
                                type: 'check',
                            },{
                                name: 'dateTime',
                                lable: '默认值',
                                value: '',
                                type: 'dateTime',
                            }]
                    },{
                        title: "属性分组",
                        type: 'number',
                        src: 'images/d-group.png'
                    },{
                        title: "表格",
                        type: 'table',
                        src: 'images/d-table.png',
                        parm: [
                            {
                                name: 'name',
                                lable: '字段名称',
                                value: '',
                                type: 'text',
                                required: true
                            },{
                                name: 'required',
                                lable: '是否必填',
                                value: false,
                                type: 'check',
                            },{
                                name: 'table',
                                lable: '列名',
                                value: false,
                                type: 'options',
                                options: []
                            }]
                    },{
                        title: "引用",
                        type: 'useobj',
                        src: 'images/d-quote.png',
                        parm: [
                            {
                                name: 'name',
                                lable: '字段名称',
                                value: '',
                                type: 'text',
                                required: true
                            },{
                                name: 'required',
                                lable: '是否必填',
                                value: false,
                                type: 'check',
                            },{
                                name: 'useobj',
                                lable: '引用对象',
                                value: '',
                                type: 'select',
                            }]
                    },{
                        title: "附件",
                        type: 'file',
                        src: 'images/d-file.png',
                        parm: [
                            {
                                name: 'name',
                                lable: '字段名称',
                                value: '',
                                type: 'text',
                                required: true
                            },{
                                name: 'code',
                                lable: '字段编码',
                                value: '',
                                type: 'text',
                                required: true
                            },{
                                name: 'required',
                                lable: '是否必填',
                                value: false,
                                type: 'check',
                            }]
                    }],
                LayUI:{}
            }
        },
        created() {
            this.selectNav(this.left_nav[0])
        },
        mounted() {
            this.initLayUI()
        },
        methods: {
            layVerify(item){
                // console.log('**********************')
                // console.log(item)
                var verify = ''
                if(item.maxLength||item.minLength){
                    verify+='|length'
                }
                if (item.required){
                    verify+='|required'
                }
               return verify
            },
            // 初始化layui
            initLayUI(){
                var that = this
                this.$nextTick(function(){
                    layui.use(['element', 'table', 'form', 'jquery', 'laydate'], function () {
                        that.LayUI = {
                            element: layui.element,
                            table: layui.table,
                            form: layui.form,
                            $: layui.$,
                            laydate: layui.laydate,
                        }
                        that.LayUI.form.render()
                        that.LayUI.laydate.render({
                            elem: '#laydata',
                            type: "date"
                        })
                        that.LayUI.form.verify({
                            username: function(value, item){ //value：表单的值、item：表单的DOM对象
                                if(!new RegExp("^[a-zA-Z0-9_\u4e00-\u9fa5\\s·]+$").test(value)){
                                    return '用户名不能有特殊字符';
                                }
                                if(/^\d+\d+\d$/.test(value)){
                                    return '用户名不能全为数字';
                                }
                            },
                            length: function(value,el){
                                var item = JSON.parse(el.getAttribute('data-item'))
                                if(value.length < item.minLength){
                                    return item.title+'字段至少'+item.minLength+'个字符';
                                }
                                if(item.maxLength>0){
                                    if(value.length > item.maxLength){
                                        return item.title+'字段至多'+item.maxLength+'个字符';
                                    }
                                }
                            }
                            ,pass: [
                                /^[\S]{6,12}$/
                                ,'密码必须6到12位，且不能出现空格'
                            ]
                        });
                        //监听提交
                        layui.form.on('submit(*)', function(data){
                            console.log(data.elem) //被执行事件的元素DOM对象，一般为button对象
                            console.log(data.form) //被执行提交的form对象，一般在存在form标签时才会返回
                            console.log(data.field) //当前容器的全部表单字段，名值对形式：{name: value}
                            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                        });
                    })
                })
            },
            //拖拽回调
            handleDrop(data) {
                var that = this
                console.log(data)
                if(!data){ return }
                this.cur_drap = JSON.parse(JSON.stringify(data))
                this.msgBoxShow = true
                this.$nextTick(function () {
                    that.LayUI.form.render()
                    that.LayUI.laydate.render({
                        elem: '#laydata',
                        type: "date",
                        done: function(value, date, endDate){
                            that.cur_drap.parm.forEach((parm)=>{
                                if(parm.type=='dateTime'){
                                    parm.value = value
                                }
                            })
                        }
                    })
                })
            },
            //保存拖拽添加
            saveDrap() {
                var maxLength,minLength,code,hasCode;
                if(!this.cur_drap.parm[0].value){ layer.msg('字段名称不能为空'); return;}
                this.cur_drap.parm.forEach((parm)=>{
                    if(parm.name == 'maxLength'){ maxLength = parm.value }
                    if(parm.name == 'minLength'){ minLength = parm.value }
                    if(parm.name == 'code'){  code = parm.value;hasCode = true }
                })
                if(maxLength){if(maxLength<minLength){ layer.msg('最大文本长度不能小于最小文本长度'); return; }}
                if(!code&&hasCode){layer.msg('字段编码不能为空'); return; }
                console.log(code)
                if(code){
                    var reg= /^[A-Za-z]/;
                    if (!reg.test(code)){
                        layer.msg('字段编码首字符必须为字母'); return;
                    }
                    if (code.length<3||code>30){
                        layer.msg('字段编码需输入3-30个字母或数字'); return;
                    }
                }
                if(maxLength<0){ layer.msg('最大文本长度不能小于0'); return; }
                if(minLength<0){ layer.msg('最小文本长度不能小于0'); return; }
                this.msgBoxShow = false
                var rules,required_data,dateTime
                if(this.$refs.rules){
                    rules = this.$refs.rules.length ? this.$refs.rules[0].value : ''
                }
                var required = this.$refs.required ? this.$refs.required[0].checked : ''
                if(this.$refs.required_data){
                    console.log(this.$refs.required_data)
                    required_data = this.$refs.required_data.length ? this.$refs.required_data[0].checked : ''
                }
                if(this.$refs.dateTime){
                    dateTime = this.$refs.dateTime.length ? this.$refs.dateTime[0].value : ''
                }
                this.cur_drap.parm.forEach((item)=>{
                    if(rules && item.name=='rules'){ item.value = rules }
                    if(item.name=='required'){ item.value = required }
                    if(item.name=='required_data'){ item.value = required_data }
                    if(item.name=='dateTime'){ item.value = dateTime }
                })
                this.addBasicInfo()
            },
            //添加基础信息
            addBasicInfo() {
                var that = this,
                    newAddObj = {},
                    newAddObj = this.cur_drap
                    newAddObj.value = ''
                this.cur_drap.parm.forEach((parm)=>{
                    if(parm.name=='name'){ newAddObj.title = parm.value }
                    if(parm.name=='required'){ newAddObj.required = parm.value }
                    if(parm.name=='default'){ newAddObj.value = parm.value}
                    if(parm.name=='options'){ newAddObj.options = parm.options }
                    if(parm.name=='unit'){ newAddObj.unit = parm.value }
                    if(parm.name=='maxLength'){ newAddObj.maxLength = parm.value }
                    if(parm.name=='minLength'){ newAddObj.minLength = parm.value }
                    if(parm.name=='dateTime'){ newAddObj.value = parm.value }
                    if(parm.name=='table'){ newAddObj.options = parm.options }
                })
                if(newAddObj.options){
                    newAddObj.options.forEach((op)=>{
                        if(op.isSelect){
                            newAddObj.value = op.opName
                        }
                    })
                }
                console.log(newAddObj)
                this.left_nav.forEach((item)=>{
                    if(item.selected){
                        item.attr.push(newAddObj)
                    }
                })
                this.$nextTick(function () {
                    that.LayUI.form.render()
                    that.LayUI.laydate.render({
                        elem: document.getElementById('laydate' + newAddObj.title),
                        type: 'date',
                        value: newAddObj.value
                    })
                    var table = []
                    if(newAddObj.options){//table添加
                        if(newAddObj.options.length&&newAddObj.type=='table'){
                            newAddObj.options.forEach((op)=>{
                                table.push({
                                    field: op.opName, title: op.opName
                                })
                            })
                            table.push({
                                field:'edit',title:'操作'
                            })
                        }
                    }
                    that.LayUI.table.render({
                        elem: document.getElementById('laytable' + newAddObj.title),
                        cols: [table],
                        data: [{
                            'edit': '<div class="layui-btn" style="height: 28px;line-height: 28px;">编辑</div><div class="layui-btn layui-btn-danger" style="height: 28px;line-height: 28px;">删除</div>'
                        }]
                    });
                });
                console.log(this.cur_select)
            },
            //选择左边导航
            selectNav(item) {
                this.left_nav.forEach((i)=>{
                    i.selected = false
                    if(i.id == item.id){
                        i.selected = true
                        this.cur_select = i
                    }
                })
            },
            //添加options
            addOption(item){
                console.log(item)
                item.options.push({
                    isSelect: false,
                    opName: ''
                })
                this.$nextTick(function () {
                    layui.use(['form'], function(){
                        layui.form.render()
                    });
                });
            },
            changeFile(e,item){
                console.log(e)
                console.log(item)
                item.value = e
            },
            //选择options默认值
            checkOption(item,index) {
                item.options.forEach((i)=>{
                    i.isSelect = false
                    item.options[index].isSelect = true
                })

            },
            navEdit() {
                console.log(123)
            }
        }
    })
</script>
</body>
</html>
